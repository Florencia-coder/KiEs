<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Análisis Lateral</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/analysis_lateral.css') }}"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="container">
      <!-- Header -->
      <header>
        <h1 class="text-center">ANÁLISIS LATERAL</h1>
      </header>

      <!-- Info Boxes -->
      <div class="info-img-box" id="infoImgBox">
        <i class="bi bi-info-circle"></i>
        La imagen de la persona debe ser de cuerpo entero de pie, de vista
        lateral izquierda o derecha a la cámara. La ropa debe ser ajustada y
        contrastada con el fondo.
      </div>
      <div class="info-box" id="infoBox">
        <i class="bi bi-info-circle"></i>
        <span>Para realizar el análisis, deberás marcar 6 puntos en la siguiente secuencia:</span><br>
        <span>Puntos p1 y p2: Marca el inicio y el final de una trayectoria lineal a la altura cervical.</span><br>
        <span>Puntos p3 y p4: Marca el inicio y el final de una trayectoria lineal a la altura dorsal.</span><br>
        <span>Puntos p5 y p6: Marca el inicio y el final de una trayectoria lineal a la altura lumbar.</span>
      </div>
      
      

      <!-- Image Upload and Preview Section -->
      <div class="container_img">
        <div class="card" id="uploadCard">
          <label class="custom-upload">
            <input
              class="form-control"
              type="file"
              id="file"
              name="file"
              accept="image/*"
              onchange="previewImage(event)"
            />
            <img
            src="{{ url_for('static', filename='img/monigoto_lateral.avif') }}"
            width="30px"
            style="opacity: 0.7"
            alt="Imagen de ejemplo"
          />
            Haz clic aquí para seleccionar una imagen
          </label>
        </div>

        <div class="text-center">
          <div class="image-container" id="imageContainer">
            <img
              id="imagePreview"
              src="#"
              alt="Vista previa de la imagen"
              style="display: none"
              onclick="markPoint(event)"
            />
            <button class="remove-img" onclick="removeImage()" id="removeImg">
              <i class="bi bi-x-circle"></i>
            </button>
          </div>
        </div>

        <!-- Control Buttons -->
        <button
          type="button"
          class="btn btn-light remove-button"
          onclick="removePoint()"
        >
        <i class="bi bi-x icon-remove"></i> Remover ultimo punto
        </button>
        <button
          type="submit"
          class="button btn btn-outline-success btn-custom"
          id="analyzeButton"
          onclick="analyzePoints()"
        >
          ANALIZAR PUNTOS
        </button>
      </div>

      <!-- Result Section -->
      <div id="result">
        <ul id="asymmetryList" class="asymmetry-list"></ul>
      </div>

      <!-- Save Analysis and Back Button -->
      <button
        type="submit"
        id="generateButton"
        class="button btn btn-outline-success btn-custom"
      >
        GUARDAR ANÁLISIS
      </button>
      <a
        href="{{ url_for('analysis_selection') }}"
        class="btn btn-light btn-bottom-left"
      >
        <i class="bi bi-arrow-left"></i> Volver a sección de análisis
      </a>
    </div>

    <!-- Scripts -->
    <script src="..\static\js\analisys_lateral\script.js"></script>
    <!-- Botón oculto para análisis -->
    <button id="analyzeButton" style="display: none">Analizar</button>

    <!-- Footer -->
    <footer>
      <p>&copy; 2024 KiEs. Todos los derechos reservados.</p>
    </footer>

    <!-- External Libraries -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- PDF Generation Script -->
  <script>
      const pacienteDatos = JSON.parse('{{ paciente | tojson | safe }}');

      function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        let lineSpacing = 8;
        const marginLeft = 15;
        let yPosition = 20; // Posición inicial

        // Título del documento
        doc.setFont("Helvetica", "bold");
        doc.setFontSize(14);
        doc.text("ANÁLISIS DE IMAGEN LATERAL", 105, 20, {
          align: "center",
        });
        doc.setLineWidth(0.5);
        doc.line(65, 21, 144, 21); // Subrayado del título

        // Agregar logo
        const logoImg = new Image();
        logoImg.src = "static/img/logo.png";

        logoImg.onload = function () {
          const logoWidth = 16;
          const logoHeight = (logoImg.height / logoImg.width) * logoWidth;
          doc.addImage(logoImg, "PNG", 10, 8, logoWidth, logoHeight);
          doc.setFont("helvetica", "normal");
          doc.setFontSize(6);
          doc.text("KiEs", 18, 28, { align: "center" });

          // Información del paciente
          doc.setFont("Helvetica", "normal");
          doc.setFontSize(12);
          doc.text("DATOS DEL PACIENTE:", 15, 45);
          doc.setLineWidth(0.3);
          doc.line(15, 46, 62, 46); // Línea debajo de "DATOS DEL PACIENTE"

          const datosPacienteY = 52;
          lineSpacing = 4;
          doc.setFontSize(10);
          doc.setFont("Helvetica", "Oblique");
          doc.text(`DNI: ${pacienteDatos["dni"]}`, 15, datosPacienteY);
          doc.text(
            `Nombre: ${pacienteDatos.name}`,
            15,
            datosPacienteY + lineSpacing
          );
          doc.text(
            `Edad: ${pacienteDatos.age}`,
            15,
            datosPacienteY + 2 * lineSpacing
          );
          doc.text(
            `Altura: ${pacienteDatos.height}`,
            15,
            datosPacienteY + 3 * lineSpacing
          );
          doc.text(
            `Peso: ${pacienteDatos.weight}`,
            15,
            datosPacienteY + 4 * lineSpacing
          );
          doc.text(
            `Fecha de análisis: ${pacienteDatos.consultaDate}`,
            15,
            datosPacienteY + 5 * lineSpacing
          );
          doc.text(
            `Historial: ${pacienteDatos.historial}`,
            15,
            datosPacienteY + 6 * lineSpacing
          );

          const imageYPosition = datosPacienteY + 6 * lineSpacing + 5; // Ajuste para la línea superior de la imagen

          // Capturar la imagen del análisis y agregarla al PDF
          const imageContainer = document.getElementById("imageContainer");
          html2canvas(imageContainer).then((canvas) => {
            const imgWidth = canvas.width;
            const imgHeight = canvas.height;
            const pdfWidth = doc.internal.pageSize.getWidth();
            const scaleFactor = 0.4;

            let imgScaledWidth = pdfWidth * scaleFactor;
            let imgScaledHeight = (imgHeight * imgScaledWidth) / imgWidth;

            const posX = (pdfWidth - imgScaledWidth) / 2;
            const posY = imageYPosition + 5;

            // Línea superior de la imagen
            doc.line(15, imageYPosition, pdfWidth - 15, imageYPosition);

            // Agregar la imagen escalada y centrada
            const imgData = canvas.toDataURL("image/png");
            doc.addImage(
              imgData,
              "PNG",
              posX,
              posY,
              imgScaledWidth,
              imgScaledHeight
            );

            // Línea inferior de la imagen
            const lineBelowImage = posY + imgScaledHeight + 5;
            doc.line(15, lineBelowImage, pdfWidth - 15, lineBelowImage);

            // Título "RESULTADOS DE ANÁLISIS" debajo de la imagen
            doc.setFont("Helvetica", "normal");
            doc.setFontSize(12);
            doc.text("RESULTADOS DE ANÁLISIS:", 15, lineBelowImage + 10);
            doc.setLineWidth(0.3);
            doc.line(15, lineBelowImage + 11, 71, lineBelowImage + 11);

            // Lista de angulos
            yPosition = lineBelowImage + 18;
            doc.setFontSize(10);
            doc.setFont("Helvetica", "Oblique");
            
            // Verificación y cálculo de ángulos
            if (points.length >= 3) {
              const anguloCervical = calcularAngulo(points[0], points[1], points[2], points[3]);
              const evaluacionCervical = evaluarCervical(anguloCervical);
              doc.text(
                `• Ángulo Dorsal: ${anguloCervical.toFixed(2)}° - ${evaluacionCervical}`,
                15,
               yPosition
              );
              yPosition += lineSpacing;

              if (points.length >= 4) {
                const anguloDorsal = calcularAngulo(points[2], points[3], points[4], points[5]);
                const evaluacionDorsal = evaluarDorsal(anguloDorsal);
                doc.text(
                  `• Ángulo Lumbar: ${anguloDorsal.toFixed(2)}° - ${evaluacionDorsal}`,
                  15,
                  yPosition
                );
              }
            }

            // Guardar el PDF
        doc.save(`Análisis_lateral_${pacienteDatos["dni"]}_${pacienteDatos.consultaDate}.pdf`);
          });
        };
      }

      document.getElementById("generateButton").addEventListener("click", (event) => {
        event.preventDefault();
        generatePDF();
      });
    </script>
  </body>
</html>
