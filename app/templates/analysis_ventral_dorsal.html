<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ANÁLISIS VENTRAL-DORSAL</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />

    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="../static/css/analysis_ventral.css" />
  </head>
  <body id="root">
    <div class="container" id="container">
      <header>
        <h1 class="text-center">ANÁLISIS VENTRAL - DORSAL</h1>
      </header>
      <button id="backImg" class="btn btn-light btn-left-top">
        <i class="bi bi-arrow-left"></i>
      </button>
      <div class="info-img-box" id="infoImgBox">
        <i class="bi bi-info-circle"></i>
        La imagen de la persona debe ser de cuerpo entero con torso desnudo, o
        con ropa ajustada contrastada con el fondo. Preferentemente de espalda a
        la cámara.
      </div>
      <div class="info-box" id="infoBox">
        <i class="bi bi-info-circle"></i>
        Debe marcar los primeros 2 puntos; a la altura del acromion de ambas
        escápulas de la persona.Y los siguientes 2 puntos; a la altura del punto
        más superior de las crestas ilíacas izquierda y derecha para realizar el
        análisis.
      </div>
      <div class="container-card" id="containerCard">
        <div class="card">
          <!-- Botón de subir imagen funcional -->
          <button type="button" id="uploadButton" class="custom-upload">
            <i class="bi bi-camera"></i>
            Subir imagen
          </button>
          <input
            type="file"
            id="uploadImage"
            name="image"
            style="display: none"
            accept="image/*"
            onchange="handleImageUpload(event)"
          />
        </div>
        <div class="card">
          <!-- Botón de subir imagen funcional -->
          <button type="button" id="liveAnalysisBtn" class="custom-upload">
            <i class="bi bi-camera-video"></i>
            Análisis en vivo
          </button>
        </div>
      </div>
      <canvas id="canvas"></canvas>
      <div class="button-container">
        <button
          type="button"
          id="removeLastPoint"
          class="btn btn-light remove-button"
          onclick="handleRemoveLastPoint()"
        >
          <i class="bi bi-arrow-left"></i>
          Remover ultimo punto
        </button>
        <button
          type="button"
          id="analyzeButton"
          class="button btn btn-outline-success btn-custom"
        >
          Analizar puntos
        </button>
      </div>
      <video id="videoFeed" autoplay alt="Video en vivo"></video>
      <canvas id="output_canvas" width="600px" height="600px"></canvas>
      <button id="captureImageButton" class="button">Capturar</button>
      <!-- Imagen capturada se mostrará aquí -->
      <img id="capturedImage" alt="Imagen Capturada" />
      <ul id="angleList" class="angle-list"></ul>
      <a
        href="{{ url_for('analysis_selection') }}"
        class="btn btn-light btn-bottom-left"
      >
        <i class="bi bi-arrow-left"></i> Volver a sección de análisis
      </a>
    </div>
    <!-- Footer -->
    <footer>
      <p>&copy; 2024 KiEs. Todos los derechos reservados.</p>
    </footer>
    <!-- <script src="../static/js/analysis_ventral/script.js"></script> -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils"></script>

    <script>
      const videoElement = document.getElementById("videoFeed");

      // Cargar la cámara del usuario
      navigator.mediaDevices
        .getUserMedia({ video: true })
        .then((stream) => {
          videoElement.srcObject = stream;
        })
        .catch((error) => {
          console.error("Error al acceder a la cámara:", error);
        });

      const pose = new Pose({
        locateFile: (file) =>
          `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${file}`,
      });
      pose.setOptions({
        modelComplexity: 1,
        smoothLandmarks: true,
        enableSegmentation: false,
        smoothSegmentation: true,
        minDetectionConfidence: 0.5,
        minTrackingConfidence: 0.5,
      });

      pose.onResults(onResults);

      function onResults(results) {
        const canvasElement = document.getElementById("output_canvas");
        const canvasCtx = canvasElement.getContext("2d");
        canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);

        if (results.poseLandmarks) {
          // Asegúrate de que `drawConnectors` esté cargado
          window.drawConnectors(
            canvasCtx,
            results.poseLandmarks,
            POSE_CONNECTIONS,
            { color: "#00FF00", lineWidth: 4 }
          );
        }
      }

      function drawLandmarks(landmarks) {
        // Dibujar puntos y conexiones de pose usando MediaPipe DrawingUtils
        drawConnectors(canvasCtx, landmarks, POSE_CONNECTIONS, {
          color: "#00FF00",
          lineWidth: 2,
        });
        drawLandmarks(canvasCtx, landmarks, { color: "#FF0000", lineWidth: 2 });

        // Calcular y mostrar ángulos
        const leftShoulder = landmarks[11];
        const rightShoulder = landmarks[12];
        const leftHip = landmarks[23];
        const rightHip = landmarks[24];

        // Calcular ángulos de hombros y caderas
        const shoulderAngle = calculateAngle(leftShoulder, rightShoulder);
        const hipAngle = calculateAngle(leftHip, rightHip);

        // Mostrar ángulos en el canvas
        canvasCtx.fillStyle = "blue";
        canvasCtx.font = "16px Arial";
        canvasCtx.fillText(
          `Ángulo de Hombros: ${Math.round(shoulderAngle)}°`,
          10,
          30
        );
        canvasCtx.fillText(
          `Ángulo de Caderas: ${Math.round(hipAngle)}°`,
          10,
          60
        );
      }

      function calculateAngle(point1, point2) {
        const dy = point2.y - point1.y;
        const dx = point2.x - point1.x;
        return Math.abs(Math.atan2(dy, dx) * (180 / Math.PI)); // Convertir radianes a grados
      }

      // Capturar video de la cámara y procesarlo con MediaPipe Pose
      async function detectPose() {
        await pose.send({ image: videoElement });
        requestAnimationFrame(detectPose);
      }

      videoElement.onloadeddata = () => {
        detectPose();
      };
    </script>
  </body>
</html>
